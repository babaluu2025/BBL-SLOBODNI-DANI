<script>
let employees = JSON.parse(localStorage.getItem("employees_v2")||"[]");
if(employees.length===0){
  for(let i=1;i<=50;i++){ employees.push({name:"Zaposleni "+i, order:i, off:[], vac:[]}); }
  saveEmployees();
}

let currentEmp=null;
let currentMode='off';
let currentDate=new Date();

function saveEmployees(){ localStorage.setItem("employees_v2", JSON.stringify(employees)); }

function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function loadEmployees(){
  let list=document.getElementById("employeeList");
  list.innerHTML="";
  employees.sort((a,b)=>a.order-b.order);
  employees.forEach((emp)=>{
    let btn=document.createElement("button");
    btn.className="btn";
    btn.textContent=emp.name;
    btn.onclick=()=>openCalendar(emp.name);
    // duži klik za promenu imena
    let pressTimer;
    btn.addEventListener("touchstart", ()=>{ pressTimer=setTimeout(()=>renameEmployee(emp.name),700); });
    btn.addEventListener("touchend", ()=>clearTimeout(pressTimer));
    btn.addEventListener("mousedown", ()=>{ pressTimer=setTimeout(()=>renameEmployee(emp.name),700); });
    btn.addEventListener("mouseup", ()=>clearTimeout(pressTimer));
    list.appendChild(btn);
  });
}

function renameEmployee(oldName){
  let newName=prompt("Novo ime za "+oldName, oldName);
  if(newName && newName.trim()!==""){
    let emp=employees.find(e=>e.name===oldName);
    emp.name=newName.trim();
    emp.order=Math.min(...employees.map(e=>e.order))-1;
    saveEmployees(); loadEmployees();
  }
}

function openCalendar(name){
  currentEmp=employees.find(e=>e.name===name);
  document.getElementById("empName").textContent=name;
  renderCalendar();
  updateModeButtons();
  showScreen("calendarScreen");
}

function renderCalendar(){
  let area=document.getElementById("calendarArea");
  area.innerHTML="";
  let year=currentDate.getFullYear();
  let month=currentDate.getMonth();
  document.getElementById("monthHeader").textContent=monthName(month)+" "+year;
  let firstDay=new Date(year,month,1);
  let startDay=firstDay.getDay(); if(startDay===0) startDay=7;
  let daysInMonth=new Date(year,month+1,0).getDate();
  for(let i=1;i<startDay;i++){ let e=document.createElement("div"); area.appendChild(e); }
  for(let d=1;d<=daysInMonth;d++){
    let div=document.createElement("div");
    div.className="day";
    div.textContent=d;
    let dateStr=fmtDate(new Date(year,month,d));
    if(currentEmp.off.includes(dateStr)) div.classList.add("off");
    if(currentEmp.vac.includes(dateStr)) div.classList.add("vac");
    div.onclick=()=>toggleDate(dateStr,div);
    area.appendChild(div);
  }
}

function fmtDate(d){ 
  let dd=("0"+d.getDate()).slice(-2);
  let mm=("0"+(d.getMonth()+1)).slice(-2);
  let yyyy=d.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

function monthName(m){
  const names=["Januar","Februar","Mart","April","Maj","Jun","Jul","Avgust","Septembar","Oktobar","Novembar","Decembar"];
  return names[m];
}

function setMode(m){ 
  currentMode=m; 
  updateModeButtons();
}

function updateModeButtons(){
  const offBtn=document.getElementById("offBtn");
  const vacBtn=document.getElementById("vacBtn");
  offBtn.style.border = currentMode==='off' ? '3px solid black' : 'none';
  vacBtn.style.border = currentMode==='vac' ? '3px solid black' : 'none';
  offBtn.style.opacity = currentMode==='off' ? '1' : '0.6';
  vacBtn.style.opacity = currentMode==='vac' ? '1' : '0.6';
}

function toggleDate(dateStr,div){
  if(currentMode==='off'){
    if(currentEmp.off.includes(dateStr)){
      currentEmp.off=currentEmp.off.filter(x=>x!==dateStr);
      div.classList.remove("off");
    } else {
      currentEmp.off.push(dateStr);
      div.classList.add("off");
      currentEmp.vac=currentEmp.vac.filter(x=>x!==dateStr);
      div.classList.remove("vac");
    }
  } else if(currentMode==='vac'){
    if(currentEmp.vac.includes(dateStr)){
      currentEmp.vac=currentEmp.vac.filter(x=>x!==dateStr);
      div.classList.remove("vac");
    } else {
      currentEmp.vac.push(dateStr);
      div.classList.add("vac");
      currentEmp.off=currentEmp.off.filter(x=>x!==dateStr);
      div.classList.remove("off");
    }
  }
  saveEmployees();
}

function prevMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderCalendar(); }
function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderCalendar(); }

function goHome(){ showScreen("home"); loadEmployees(); }

function openManager(){
  let rep="";
  employees.sort((a,b)=>a.order-b.order);
  employees.forEach(e=>{
    rep+=`<div style="background:#fff;padding:10px;margin:5px;border-radius:10px;">
      <b>${e.name}</b><br>
      <span style="color:red;">Slobodni dani (${e.off.length}):</span> ${e.off.join(", ")||"-"}<br>
      <span style="color:green;">Godišnji odmor (${e.vac.length}):</span> ${e.vac.join(", ")||"-"}
    </div>`;
  });
  document.getElementById("report").innerHTML=rep;
  showScreen("manager");
}

function resetAll(){
  if(confirm("Da li želiš obrisati sve podatke?")){
    employees=[];
    for(let i=1;i<=50;i++){ employees.push({name:"Zaposleni "+i, order:i, off:[], vac:[]}); }
    saveEmployees(); loadEmployees();
  }
}

loadEmployees();
</script>
